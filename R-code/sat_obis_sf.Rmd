---
title: "OBIS+Env within polygons"
author: "eqmh"
date: "9/1/2021"
output: html_document
---

```{r setup}
library(sf)
library(leaflet)
library(dplyr)
library(ggplot2)
library(readr)
library(rerddap)
library(mapdata)
```


```{r}
# setting variables and paths allows for caching data files
geometry = "meow" # or see: ?get_url_ply
dir_data  = here::here("data")
dir_ply   = glue::glue("{dir_data}/ply")
dir_ply

# # First make sure the polygon files are available on '~/data/ply'. Then select polygon from the list contained in 'meow_ecos.shp' by changing the ECO_CODE_X code.
ply <- st_read("~/obis_sat_poly/data/ply/meow/meow_ecos.shp") %>% subset(ECO_CODE_X == "175", geometry) 
```


## Extract maximum and minimum polygon coordinates

```{r}
bbox_list <- lapply(st_geometry(ply), st_bbox)
maxmin <- as.data.frame(matrix(unlist(bbox_list),nrow=nrow(ply)))
names(maxmin) <- names(bbox_list[[1]])
```


## Create a map of the latest SST data. 

```{r, message=FALSE, warning=FALSE}
# define geographic domain
lat_lims<- c(maxmin$ymin, maxmin$ymax)  ## change the first and second value for desired minimum and maximum latitude.
lon_lims <- c(maxmin$xmin, maxmin$xmax)  ## change the first and second value for desired minimum and maximum longitude.

sstInfo <- info('jplMURSST41mday')
# get latest composite sst
GHRSST <- griddap(sstInfo, latitude = lat_lims, longitude = lon_lims, time = c('last','last'), fields = 'sst')

mycolor <- colors$temperature
sst_map <- map_data("worldHires", ylim = lat_lims, xlim = lon_lims)
ggplot(data = GHRSST$data, aes(x = lon, y = lat, fill = sst)) + 
  geom_polygon(data = sst_map, aes(x = long, y = lat, group = group), fill = "grey80") +
  geom_raster(interpolate = FALSE) +
  scale_fill_gradientn(colours = mycolor, na.value = NA) +
  theme_bw() + ylab("latitude") + xlab("longitude") +
  coord_fixed(1.1, xlim = lon_lims,  ylim = lat_lims) + ggtitle("Latest SST")
```


## Create a map of the latest CHL data. 

```{r, message=FALSE, warning=FALSE}
# define geographic domain
chlaInfo <- info('nesdisVHNSQchlaMonthly')
CHLA <- griddap(chlaInfo, latitude = lat_lims, longitude = lon_lims, time = c('last','last'), fields = 'chlor_a')

# Map monthly chl (VIIRS)
mycolor <- colors$chlorophyll
chl_map <- map_data("worldHires", ylim = lat_lims, xlim = lon_lims)
ggplot(data = CHLA$data, aes(x = lon, y = lat, fill = log(chlor_a))) + 
  geom_polygon(data = chl_map, aes(x = long, y = lat, group = group), fill = "grey80") +
  geom_raster(interpolate = FALSE) +
  scale_fill_gradientn(colours = mycolor, na.value = NA) +
  theme_bw() + ylab("latitude") + xlab("longitude") +
  coord_fixed(1.3, xlim = lon_lims,  ylim = lat_lims) + ggtitle("Last month")
```

## Extract occurence data from OBIS within MPAs for selected country (takes a long time for data rich MPAs!)

```{r obis}
depth = 200
mol = 51
echi = 1806
anne = 882
plan = 3

# gets the occurrence data for a single multipolygon (one row of WDPA table)
get_one_geom <- function(x, key){
   robis::occurrence(taxonid = c(mol, echi, anne, plan), 
                     enddepth = depth, 
                     geometry = sf::st_as_text(sf::st_convex_hull(sf::st_geometry(x))))
}

df <- ply %>%
  dplyr::rowwise() %>%
  dplyr::group_map(get_one_geom,
                   .keep = TRUE) %>%
  dplyr::bind_rows()
   
```


## Visualize occurrence records from OBIS for selected country (takes a long time for data rich MPAs!)

```{r}
taxa_list <- unique(df$phylum)
mollusca <- df %>% filter(phylum == taxa_list[1])
annelida <- df %>% filter(phylum == taxa_list[2])
plantae <- df %>% filter(phylum == taxa_list[3])
echinodermata <- df %>% filter(phylum == taxa_list[4])

colors <- c("#31a354", "#de2d26", "#2b8cbe", "#756bb1")
labels <- c(taxa_list[1], taxa_list[2], taxa_list[3], taxa_list[4])
leaflet() %>%
  addTiles("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png") %>%
  addPolygons(data = ply$geometry) %>%
  addCircleMarkers(lat = mollusca$decimalLatitude, lng = mollusca$decimalLongitude, 
                   radius = 5, weight = 0, fillColor = colors[1], fillOpacity = 1) %>%
  addCircleMarkers(lat = annelida$decimalLatitude, lng = annelida$decimalLongitude, 
                   radius = 5, weight = 0, fillColor = colors[2], fillOpacity = 1) %>%
  addCircleMarkers(lat = plantae$decimalLatitude, lng = plantae$decimalLongitude, 
                   radius = 5, weight = 0, fillColor = colors[3], fillOpacity = 1) %>%
  addCircleMarkers(lat = echinodermata$decimalLatitude, lng = echinodermata$decimalLongitude, 
                   radius = 5, weight = 0, fillColor = colors[4], fillOpacity = 1) %>%
  addLegend(position = "topright", colors = colors, labels = labels)

```

## Generate a time series plot of OBIS records

```{r}
(ts_plot <- ggplot() +
  geom_histogram(data = df, aes(x = date_year, fill = phylum), binwidth = 2) + 
  scale_fill_brewer(palette = "Spectral") + 
  xlim(c(1960, 2017)) + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  theme(axis.text.x = element_text(size=14, angle=0), 
        axis.text.y = element_text(size=14, angle=0)))
```

## Extracts OBIS records by looping through the list of geometries (e.g. MEOWs)

```{r}
ply_biome <- st_read("~/obis_sat_poly/data/ply/meow/meow_ecos.shp") %>% subset(RLM_CODE == "7")  ## does not work with all RLM_CODE

convert_geom_to_WKT <- function(x){
  st_as_text(st_convex_hull(st_geometry(x)))
}

get_one_dataset <- function(x, key){
    robis::dataset(geometry=convert_geom_to_WKT(x))
  }

rec_summ <- matrix(ncol = 2, nrow = nrow(ply_biome)) 

for (j in 1:nrow(ply_biome)){
  geom_rec <- ply_biome$geometry[j] %>% get_one_dataset()
      num_rec <- sum(geom_rec$records)
      geom_id <- ply_biome$ECO_CODE_X[j]
      rec_summ[j, ] <- cbind(geom_id, as.integer(num_rec))
}
rec_summ <- data.frame(rec_summ) 
colnames(rec_summ) <- c("ECO_CODE_X", "records")

ply_biome <- cbind(ply_biome, rec_summ$records) %>% setnames(old = c('rec_summ.records'), new = c('records'))
ply_biome$records <- sapply(ply_biome$records, as.numeric)
```

## Generates map with MEOW with ECO_CODE_X and number of OBIS records

```{r}
bins <- c(0, 1000, 10000, 100000, 200000, Inf)
pal <- colorBin("YlOrRd", domain = ply_biome$records, bins = bins)

leafletplot <- leaflet(data=ply_biome) %>% 
  addTiles("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png") %>% 
  addPolygons(
    popup = ~sprintf("%s, %s", ECO_CODE_X, records),
    fillColor = ~pal(records),
      weight = 2,
      opacity = 1,
      color = "white",
      dashArray = "3",
      fillOpacity = 0.7) %>% 
  addLegend(pal = pal, values = ~records, opacity = 0.7, title = NULL,
  position = "bottomright")
leafletplot 
```


