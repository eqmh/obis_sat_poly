---
title: "test"
author: "eqmh"
date: "9/1/2021"
output: html_document
---

```{r setup}
library(sf)
library(leaflet)
library(dplyr)
library(ggplot2)
```


```{r}
# setting variables and paths allows for caching data files
geometry = "meow" # or see: ?get_url_ply
dir_data  = here::here("data")
dir_ply   = glue::glue("{dir_data}/ply")
dir_ply

# # First make sure the polygon files are available on '~/seascapeR/data_ss2/ply'. Then select polygon from the list contained in 'meow_ecos.shp' by changing the ECOREGION name.
ply <- st_read("~/obis_sat_poly/data/ply/meow/meow_ecos.shp") %>% subset(ECO_CODE_X == "175", geometry) 
```
## Extract occurence data from OBIS within MPAs for selected country (takes a long time for data rich MPAs!)

```{r obis}
depth = 200
mol = 51
echi = 1806
anne = 882
plan = 3

# gets the occurrence data for a single multipolygon (one row of WDPA table)
get_one_geom <- function(x, key){
   robis::occurrence(taxonid = c(mol, echi, anne, plan), 
                     enddepth = depth, 
                     geometry = sf::st_as_text(sf::st_convex_hull(sf::st_geometry(x))))
}

df <- ply %>%
  dplyr::rowwise() %>%
  dplyr::group_map(get_one_geom,
                   .keep = TRUE) %>%
  dplyr::bind_rows()
   
```


## Visualize occurrence records from OBIS for selected country (takes a long time for data rich MPAs!)

```{r}
leaflet() %>%
  addTiles("https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png") %>%
  addCircleMarkers(lat = df$decimalLatitude, lng = df$decimalLongitude, radius = 5, weight = 0, fillOpacity = 1, fillColor = "#cc3300")

```

## Generate a time series plot of OBIS records

```{r}
(ts_plot <- ggplot() +
  geom_histogram(data = df, aes(x = date_year, fill = phylum), binwidth = 2) + 
  scale_fill_brewer(palette = "Spectral") + 
  xlim(c(1960, 2017)) + 
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  theme(axis.text.x = element_text(size=14, angle=0), 
        axis.text.y = element_text(size=14, angle=0)))
```
 

## Extracts OBIS records by looping through the list of geometries (e.g. MEOWs)

```{r}
ply_biome <- st_read("~/obis_sat_poly/data/ply/meow/meow_ecos.shp") %>% subset(RLM_CODE == "7")  ## does not work with all RLM_CODE

convert_geom_to_WKT <- function(x){
  st_as_text(st_convex_hull(st_geometry(x)))
}

get_one_dataset <- function(x, key){
    robis::dataset(geometry=convert_geom_to_WKT(x))
  }

rec_summ <- matrix(ncol = 2, nrow = nrow(ply_biome)) 

for (j in 1:nrow(ply_biome)){
  geom_rec <- ply_biome$geometry[j] %>% get_one_dataset()
      num_rec <- sum(geom_rec$records)
      geom_id <- ply_biome$ECO_CODE_X[j]
      rec_summ[j, ] <- cbind(geom_id, as.integer(num_rec))
}
rec_summ <- data.frame(rec_summ) 
colnames(rec_summ) <- c("ECO_CODE_X", "records")

ply_biome <- cbind(ply_biome, rec_summ$records) %>% setnames(old = c('rec_summ.records'), new = c('records'))
ply_biome$records <- sapply(ply_biome$records, as.numeric)
```

## Generates map with MEOW with ECO_CODE_X and number of OBIS records

```{r}
bins <- c(0, 1000, 10000, 100000, 200000, Inf)
pal <- colorBin("YlOrRd", domain = ply_biome$records, bins = bins)

leafletplot <- leaflet(data=ply_biome) %>% 
  addProviderTiles(providers$Stamen.Watercolor, options = providerTileOptions(noWrap = TRUE)) %>% 
  addPolygons(
    popup = ~sprintf("%s, %s", ECO_CODE_X, records),
    fillColor = ~pal(records),
      weight = 2,
      opacity = 1,
      color = "white",
      dashArray = "3",
      fillOpacity = 0.7) %>% 
  addLegend(pal = pal, values = ~records, opacity = 0.7, title = NULL,
  position = "bottomright")
leafletplot 
```


